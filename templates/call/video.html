{% extends "base.html" %}
{% block title %}{{title}}{% endblock title %}
{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<style>
    video {
        width: 360px;
        height: 240px;
    }
</style>
{% endblock css %}
{% block content %}
<div class="container">

    <h5>Video call</h5>
    <h6>Room ID: {{ room_id }}</h6>
    <div class="d-flex">
        <div class="col-6">
            <h5>My video</h5>
            <video muted id="localVideo">

            </video>
        </div>
    </div>
    <div id="videoGrid">
        
    </div>
    <div class="col-12 d-flex justify-content-center">
        <button id="btn_toggle_video" class="btn btn-muted mx-1" onclick="toggleVideo()"><span class="material-icons">videocam</span></button>
        <button class="btn btn-muted mx-1"><span class="material-icons">mic</span></button>
        <button class="btn btn-muted mx-1"><span class="material-icons">stop</span></button>
    </div>
</div>
{% endblock content %}
{% block js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
<script type="text/javascript" charset="utf-8">
    const room_id = "{{room_id}}";

    const localVideo = document.getElementById('localVideo');
    const videoGrid = document.getElementById('videoGrid') 
    var localStream;
    var peers = {}
    var peerId;

    navigator.getUserMedia = (
        navigator.getUserMedia ||
        navigator.webkitGetUserMedia ||
        navigator.mozGetUserMedia ||
        navigator.msGetUserMedia
    );

    if (typeof navigator.mediaDevices.getUserMedia === 'undefined') {
        navigator.getUserMedia({
            video: true,
            audio: true
        }, gotLocalMediaStream, handleLocalMediaStreamError);
    } else {
        navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
        }).then(gotLocalMediaStream).catch(handleLocalMediaStreamError);
    }

    function gotLocalMediaStream(mediaStream) {
        addVideoStream(localVideo, mediaStream)
        localStream = mediaStream
        console.log("Cam is ok")
    }
    function handleLocalMediaStreamError(){
        console.log("Cam isnt ok")

    }

    const myPeer = new Peer()
    var socket = io();

    $(window).on("unload", function(e) {
        socket.disconnect();
        return true
    });

    myPeer.on('open', id => {
        socket.emit('join', room_id, id);
        peerId = id;
        console.log("My ID "+peerId);
    })

    myPeer.on('call', call => {

        call.answer(localStream)
        console.log("Call from")
        console.log(call)
        const video = document.createElement('video');
        call.on('stream', userVideoStream => {
            addVideoStream(video, userVideoStream)
        })
        call.on('close', () => {
            video.remove();
        })
        peers[call.peer] = call;

    })

    socket.on('connect', function() {
        socket.on('disconnect', function() {
            socket.emit('leave', room_id, peerId);
        });
    });
    socket.on('disconnect', function() {
        socket.emit('leave', room_id, peerId);
    });

    socket.on('user-connected', function(userID){
        console.log("user_connected "+userID);
        
        if(userID != myPeer._id) {
            connectToNewUser(userID, localStream)
        }
    })
    socket.on('user-disconnected', function(userID){
        console.log("user_disconnected "+userID);
        if(peers[userID]) {
            peers[userID].close();
            delete peers[userID];
            console.log("list current peers "+peers);
        } 
    })

    function addVideoStream(video, stream) {
        video.srcObject = stream;
        video.addEventListener('loadedmetadata', ()=> {
            video.play();
        })
        videoGrid.append(video);
    }
    function connectToNewUser(userId, stream) {
        console.log("add video "+userId);

        const call = myPeer.call(userId, stream);
        const video = document.createElement('video');

        call.on('stream', userVideoStream => {
            addVideoStream(video, userVideoStream);
        })
        call.on('close', () => {
            video.remove();
        })

        peers[userId] = call;
    }
</script>
{% endblock js %}